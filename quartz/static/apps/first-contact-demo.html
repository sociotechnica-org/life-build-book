<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JARVIS - First Contact</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f9fafb;
      height: 100vh;
      overflow: hidden;
    }

    .container {
      display: flex;
      height: 100vh;
    }

    /* Main Chat Area */
    .main-area {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .header {
      background: white;
      border-bottom: 1px solid #e5e7eb;
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .avatar-circle {
      width: 40px;
      height: 40px;
      background: #4f46e5;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .avatar-circle svg {
      width: 24px;
      height: 24px;
      color: white;
    }

    .header-title h1 {
      font-size: 1rem;
      font-weight: 600;
      color: #111827;
    }

    .header-title p {
      font-size: 0.875rem;
      color: #6b7280;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-size: 0.875rem;
    }

    .badge {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
    }

    .badge-stage {
      background: #eef2ff;
      color: #4f46e5;
    }

    .badge-time {
      background: #d1fae5;
      color: #065f46;
    }

    /* Messages Area */
    .messages-area {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .message {
      display: flex;
      max-width: 100%;
    }

    .message.user {
      justify-content: flex-end;
    }

    .message.assistant {
      justify-content: flex-start;
    }

    .message-bubble {
      max-width: 65%;
      padding: 0.75rem 1rem;
      border-radius: 1rem;
    }

    .message.user .message-bubble {
      background: #4f46e5;
      color: white;
    }

    .message.assistant .message-bubble {
      background: white;
      border: 1px solid #e5e7eb;
      color: #111827;
    }

    .message-content {
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .message-time {
      font-size: 0.75rem;
      margin-top: 0.25rem;
      opacity: 0.7;
    }

    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: white;
      border: 1px solid #e5e7eb;
      padding: 0.75rem 1rem;
      border-radius: 1rem;
      max-width: fit-content;
    }

    .typing-dots {
      display: flex;
      gap: 0.25rem;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      background: #9ca3af;
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    /* Cards Area */
    .cards-area {
      border-top: 1px solid #e5e7eb;
      background: #f9fafb;
      padding: 1rem;
    }

    .cards-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 0.75rem;
    }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }

    .card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 0.5rem;
      padding: 1rem;
      transition: all 0.2s;
    }

    .card:hover {
      border-color: #d1d5db;
    }

    .card.activated {
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .card-icon {
      padding: 0.375rem;
      border-radius: 0.25rem;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card-icon svg {
      width: 16px;
      height: 16px;
    }

    .card-type {
      font-size: 0.75rem;
      font-weight: 500;
      color: #6b7280;
    }

    .card-time {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-left: auto;
    }

    .card-title {
      font-weight: 600;
      color: #111827;
      margin-bottom: 0.5rem;
    }

    .card-description {
      font-size: 0.875rem;
      color: #6b7280;
      margin-bottom: 0.75rem;
    }

    .card-criteria-title {
      font-size: 0.75rem;
      font-weight: 500;
      color: #6b7280;
      margin-bottom: 0.25rem;
    }

    .card-criteria {
      margin-bottom: 0.75rem;
    }

    .criterion {
      display: flex;
      align-items: start;
      gap: 0.5rem;
      font-size: 0.75rem;
      color: #6b7280;
      margin-bottom: 0.25rem;
    }

    .criterion svg {
      width: 12px;
      height: 12px;
      margin-top: 2px;
      flex-shrink: 0;
    }

    .card-button {
      width: 100%;
      padding: 0.5rem;
      border: none;
      border-radius: 0.25rem;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .card-button.active {
      background: #4f46e5;
      color: white;
    }

    .card-button.inactive {
      background: #eef2ff;
      color: #4f46e5;
    }

    .card-button.inactive:hover {
      background: #e0e7ff;
    }

    .card-button.disabled {
      background: #f3f4f6;
      color: #9ca3af;
      cursor: not-allowed;
    }

    /* Input Area */
    .input-area {
      border-top: 1px solid #e5e7eb;
      background: white;
      padding: 1rem;
    }

    .input-container {
      display: flex;
      align-items: flex-end;
      gap: 0.75rem;
    }

    .input-field {
      flex: 1;
      resize: none;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      padding: 0.75rem 1rem;
      font-family: inherit;
      font-size: 0.875rem;
      outline: none;
      transition: border-color 0.2s;
    }

    .input-field:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .input-field:disabled {
      background: #f9fafb;
      color: #9ca3af;
    }

    .send-button {
      background: #4f46e5;
      color: white;
      border: none;
      padding: 0.75rem;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .send-button:hover:not(:disabled) {
      background: #4338ca;
    }

    .send-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .send-button svg {
      width: 20px;
      height: 20px;
    }

    /* Insights Sidebar */
    .sidebar {
      width: 320px;
      border-left: 1px solid #e5e7eb;
      background: white;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      padding: 1rem;
      border-bottom: 1px solid #e5e7eb;
    }

    .sidebar-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 600;
      color: #111827;
    }

    .sidebar-title svg {
      width: 20px;
      height: 20px;
      color: #4f46e5;
    }

    .sidebar-subtitle {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.25rem;
    }

    .sidebar-content {
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .insight-section {

    }

    .insight-title {
      font-size: 0.875rem;
      font-weight: 500;
      color: #374151;
      margin-bottom: 0.5rem;
    }

    .insight-value {
      background: #eef2ff;
      border-radius: 0.5rem;
      padding: 0.75rem;
    }

    .insight-value-text {
      font-weight: 500;
      color: #312e81;
    }

    .insight-confidence {
      font-size: 0.75rem;
      color: #4f46e5;
      margin-top: 0.25rem;
    }

    .insight-empty {
      font-size: 0.875rem;
      color: #9ca3af;
      font-style: italic;
    }

    .crisis-display {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .crisis-score {
      font-size: 1.5rem;
      font-weight: 700;
    }

    .crisis-bar {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      border-radius: 9999px;
      margin-top: 0.5rem;
      overflow: hidden;
    }

    .crisis-bar-fill {
      height: 100%;
      transition: width 0.3s;
      border-radius: 9999px;
    }

    .domain-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .domain-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .domain-name {
      font-size: 0.875rem;
      color: #6b7280;
    }

    .domain-confidence {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    .baseline-item {
      margin-bottom: 0.75rem;
    }

    .baseline-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: #6b7280;
      margin-bottom: 0.25rem;
    }

    .baseline-bar {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      border-radius: 9999px;
      overflow: hidden;
    }

    .baseline-bar-fill {
      height: 100%;
      transition: width 0.3s;
      border-radius: 9999px;
    }

    .attributes-list, .style-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      font-size: 0.875rem;
    }

    .attribute-item, .style-item {
      display: flex;
      justify-content: space-between;
    }

    .attribute-label, .style-label {
      color: #6b7280;
    }

    .attribute-value, .style-value {
      font-weight: 500;
      color: #111827;
      text-transform: capitalize;
    }

    .metrics-footer {
      padding: 1rem;
      border-top: 1px solid #e5e7eb;
      background: #f9fafb;
      margin-top: auto;
    }

    .metrics-title {
      font-size: 0.75rem;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      margin-bottom: 0.75rem;
    }

    .metrics-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      font-size: 0.75rem;
    }

    .metric-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .metric-icon {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

    .metric-icon.complete {
      color: #10b981;
    }

    .metric-icon.incomplete {
      border: 2px solid #d1d5db;
      border-radius: 50%;
    }

    /* API Key Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal {
      background: white;
      border-radius: 0.5rem;
      padding: 2rem;
      max-width: 500px;
      width: 90%;
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #111827;
      margin-bottom: 0.5rem;
    }

    .modal-description {
      font-size: 0.875rem;
      color: #6b7280;
      margin-bottom: 1.5rem;
    }

    .modal-input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      margin-bottom: 1rem;
    }

    .modal-button {
      width: 100%;
      padding: 0.75rem;
      background: #4f46e5;
      color: white;
      border: none;
      border-radius: 0.375rem;
      font-weight: 500;
      cursor: pointer;
    }

    .modal-button:hover {
      background: #4338ca;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React & Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const JARVIS_SYSTEM_PROMPT = `You are JARVIS conducting first contact with a new Director in LifeBuild.me. You must respond in valid JSON format only.

Your role: A skilled interviewer who makes people feel deeply understood while silently building their profile.

CONVERSATION FLOW:
Turn 1 (if no messages yet): Welcome + Magic Wand Question
"Welcome to LifeBuild. I'm Jarvis, and in the next 5 minutes, I'm going to help you turn your biggest challenge into your first small victory. No forms, no setup—let's dive in.

If I could wave a magic wand and permanently solve ONE aspect of your life in the next 72 hours, what would create the biggest sense of relief or joy?"

Turn 2-3: Clarification (ONLY if response is vague or <20 words)
Ask ONE specific question about their situation.

Turn 4: Synthesis
"So if I understand correctly, you're feeling [emotion] about [situation] and you'd like to [outcome]. Is that right?"

Turn 5: If confirmed, ask for stress/energy baseline (1-10 each)

Turn 6: Generate 1-3 cards based on their situation

EXTRACTION RULES:
From EVERY user message, extract insights:

wow_profile (one of):
- "Relief Seeker" - keywords: chaos, stop, overwhelmed, drowning, breathing room
- "Empire Builder" - keywords: automation, AI, systems, scale, army
- "Strategic Thinker" - keywords: plan, connect, understand, clarity, big picture
- "Momentum Junkie" - keywords: stuck, progress, move, action, NOW
- "Systems Optimizer" - keywords: efficient, elegant, process, optimize, streamline

life_domains (array of):
- "Career" - work, job, boss, business, professional
- "Health" - exercise, diet, sleep, energy, wellness
- "Relationships" - family, friends, partner, social, connection
- "Finance" - money, budget, investing, debt, savings
- "Growth" - learning, skills, development, education
- "Home" - house, chores, organization, living space
- "Meaning" - purpose, values, fulfillment, contribution
- "Leisure" - hobbies, fun, relaxation, creativity

crisis_score (0-10):
- 0-3: Stable, aspirational
- 4-6: Stressed but managing
- 7-10: Crisis mode (keywords: drowning, can't cope, emergency, falling apart)

director_attributes (infer from language):
- energy_reserve: High/Medium/Low (from emotional intensity)
- processing_power: High/Medium/Low (from response complexity)
- agency: High/Medium/Low (internal vs external locus)
- momentum: Building/Stalled/Declining
- support_infrastructure: Strong/Developing/Weak

communication_style:
- formality: formal/casual
- detail_level: detailed/concise
- focus: action/reflection

CARD GENERATION:
When generating cards, create 1-3 cards with:
- title: Verb-led, max 10 words
- type: Execute | Plan | No-ing | Schedule | Delegate | Automate | Decide
- time_estimate: In minutes (max 90 per card)
- description: 1-3 sentences explaining why this helps
- done_criteria: Array of 2-3 objective completion markers
- priority_score: 1-10 (urgency × impact)

RESPONSE FORMAT (STRICT JSON):
{
  "message": "Your conversational response to the user",
  "insights": {
    "wow_profile": { "type": "string or null", "confidence": 0.0-1.0 },
    "life_domains": [{ "domain": "string", "confidence": 0.0-1.0 }],
    "crisis_score": 0-10,
    "director_attributes": {
      "energy_reserve": "High|Medium|Low",
      "processing_power": "High|Medium|Low",
      "agency": "High|Medium|Low",
      "momentum": "Building|Stalled|Declining",
      "support_infrastructure": "Strong|Developing|Weak"
    },
    "communication_style": {
      "formality": "formal|casual",
      "detail_level": "detailed|concise",
      "focus": "action|reflection"
    },
    "emotional_baseline": {
      "stress": null,
      "energy": null
    }
  },
  "cards": [],
  "conversation_stage": "welcome|clarifying|synthesizing|baseline|card_generation|activation"
}

CRITICAL RULES:
- ONLY output valid JSON, no other text
- Extract insights from EVERY message
- Mirror their language in your responses
- Max 2 clarifying questions before synthesis
- Cards only appear after synthesis is confirmed
- If crisis_score > 7, focus on relief/No-ing cards
- Be warm but efficient - this should feel magical, not clinical`;

    const CardTypeColors = {
      Execute: '#3b82f6',
      Plan: '#a855f7',
      'No-ing': '#ef4444',
      Schedule: '#10b981',
      Delegate: '#f97316',
      Automate: '#06b6d4',
      Decide: '#eab308'
    };

    function App() {
      const [apiKey, setApiKey] = useState(localStorage.getItem('anthropic_api_key') || '');
      const [showApiModal, setShowApiModal] = useState(!localStorage.getItem('anthropic_api_key'));
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState('');
      const [isLoading, setIsLoading] = useState(false);
      const [insights, setInsights] = useState({
        wow_profile: null,
        life_domains: [],
        crisis_score: 0,
        director_attributes: {},
        communication_style: {},
        emotional_baseline: { stress: null, energy: null }
      });
      const [cards, setCards] = useState([]);
      const [conversationStage, setConversationStage] = useState('welcome');
      const [activatedCard, setActivatedCard] = useState(null);
      const [startTime] = useState(Date.now());
      const [timeToFirstCard, setTimeToFirstCard] = useState(null);
      const messagesEndRef = useRef(null);

      const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      };

      useEffect(() => {
        scrollToBottom();
      }, [messages]);

      useEffect(() => {
        // Auto-start conversation with magic wand question
        if (messages.length === 0 && apiKey) {
          sendToJarvis([]);
        }
      }, [apiKey]);

      const saveApiKey = () => {
        localStorage.setItem('anthropic_api_key', apiKey);
        setShowApiModal(false);
      };

      const sendToJarvis = async (conversationHistory) => {
        setIsLoading(true);
        try {
          const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': apiKey,
              'anthropic-version': '2023-06-01'
            },
            body: JSON.stringify({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 2000,
              system: JARVIS_SYSTEM_PROMPT,
              messages: conversationHistory.map(msg => ({
                role: msg.role === 'user' ? 'user' : 'assistant',
                content: msg.role === 'user' ? msg.content : JSON.stringify(msg.rawResponse || { message: msg.content })
              }))
            })
          });

          if (!response.ok) {
            throw new Error(`API request failed: ${response.status}`);
          }

          const data = await response.json();
          let responseText = data.content[0].text;

          // Clean up potential markdown formatting
          responseText = responseText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();

          const parsed = JSON.parse(responseText);

          // Update insights
          if (parsed.insights) {
            setInsights(prev => {
              const newInsights = { ...prev };

              if (parsed.insights.wow_profile?.type) {
                newInsights.wow_profile = parsed.insights.wow_profile;
              }

              if (parsed.insights.life_domains?.length > 0) {
                const existingDomains = new Set(prev.life_domains.map(d => d.domain));
                parsed.insights.life_domains.forEach(domain => {
                  if (!existingDomains.has(domain.domain)) {
                    newInsights.life_domains = [...newInsights.life_domains, domain];
                  } else {
                    newInsights.life_domains = newInsights.life_domains.map(d =>
                      d.domain === domain.domain && domain.confidence > d.confidence ? domain : d
                    );
                  }
                });
              }

              if (parsed.insights.crisis_score > 0) {
                newInsights.crisis_score = Math.max(prev.crisis_score, parsed.insights.crisis_score);
              }

              if (Object.keys(parsed.insights.director_attributes || {}).length > 0) {
                newInsights.director_attributes = {
                  ...prev.director_attributes,
                  ...parsed.insights.director_attributes
                };
              }

              if (Object.keys(parsed.insights.communication_style || {}).length > 0) {
                newInsights.communication_style = {
                  ...prev.communication_style,
                  ...parsed.insights.communication_style
                };
              }

              if (parsed.insights.emotional_baseline?.stress) {
                newInsights.emotional_baseline.stress = parsed.insights.emotional_baseline.stress;
              }
              if (parsed.insights.emotional_baseline?.energy) {
                newInsights.emotional_baseline.energy = parsed.insights.emotional_baseline.energy;
              }

              return newInsights;
            });
          }

          // Update cards
          if (parsed.cards?.length > 0) {
            setCards(parsed.cards);
            if (!timeToFirstCard) {
              setTimeToFirstCard(Math.round((Date.now() - startTime) / 1000));
            }
          }

          // Update conversation stage
          if (parsed.conversation_stage) {
            setConversationStage(parsed.conversation_stage);
          }

          // Add message to chat
          setMessages(prev => [...prev, {
            role: 'assistant',
            content: parsed.message,
            rawResponse: parsed,
            timestamp: new Date()
          }]);

        } catch (error) {
          console.error('Error calling Jarvis:', error);
          setMessages(prev => [...prev, {
            role: 'assistant',
            content: "I apologize, but I'm having trouble processing that. Could you try rephrasing?",
            timestamp: new Date()
          }]);
        } finally {
          setIsLoading(false);
        }
      };

      const handleSend = async () => {
        if (!input.trim() || isLoading) return;

        const userMessage = {
          role: 'user',
          content: input.trim(),
          timestamp: new Date()
        };

        const newMessages = [...messages, userMessage];
        setMessages(newMessages);
        setInput('');

        await sendToJarvis(newMessages);
      };

      const handleKeyPress = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          handleSend();
        }
      };

      const getStageLabel = (stage) => {
        const labels = {
          welcome: 'Welcome',
          clarifying: 'Understanding',
          synthesizing: 'Synthesizing',
          baseline: 'Baseline Capture',
          card_generation: 'Creating Cards',
          activation: 'Ready to Activate'
        };
        return labels[stage] || stage;
      };

      const getCrisisColor = (score) => {
        if (score <= 3) return '#10b981';
        if (score <= 6) return '#eab308';
        return '#ef4444';
      };

      return (
        <>
          {showApiModal && (
            <div className="modal-overlay">
              <div className="modal">
                <h2 className="modal-title">Enter Anthropic API Key</h2>
                <p className="modal-description">
                  This demo uses the Claude API. Your API key will be stored locally in your browser.
                </p>
                <input
                  type="password"
                  className="modal-input"
                  value={apiKey}
                  onChange={(e) => setApiKey(e.target.value)}
                  placeholder="sk-ant-..."
                />
                <button className="modal-button" onClick={saveApiKey}>
                  Start Demo
                </button>
              </div>
            </div>
          )}

          <div className="container">
            {/* Main Chat Area */}
            <div className="main-area">
              {/* Header */}
              <div className="header">
                <div className="header-left">
                  <div className="avatar-circle">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <rect x="3" y="11" width="18" height="11" rx="2" />
                      <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                    </svg>
                  </div>
                  <div className="header-title">
                    <h1>JARVIS - First Contact</h1>
                    <p>The Magical 72 Hours Begins</p>
                  </div>
                </div>
                <div className="header-right">
                  <div className="badge badge-stage">
                    Stage: {getStageLabel(conversationStage)}
                  </div>
                  {timeToFirstCard && (
                    <div className="badge badge-time">
                      First Cards: {timeToFirstCard}s
                    </div>
                  )}
                </div>
              </div>

              {/* Messages */}
              <div className="messages-area">
                {messages.map((msg, idx) => (
                  <div key={idx} className={`message ${msg.role}`}>
                    <div className="message-bubble">
                      <div className="message-content">{msg.content}</div>
                      <div className="message-time">
                        {msg.timestamp.toLocaleTimeString()}
                      </div>
                    </div>
                  </div>
                ))}

                {isLoading && (
                  <div className="message assistant">
                    <div className="typing-indicator">
                      <div className="typing-dots">
                        <div className="typing-dot"></div>
                        <div className="typing-dot"></div>
                        <div className="typing-dot"></div>
                      </div>
                      <span style={{ fontSize: '0.875rem', color: '#6b7280' }}>Jarvis is thinking...</span>
                    </div>
                  </div>
                )}

                <div ref={messagesEndRef} />
              </div>

              {/* Cards Display */}
              {cards.length > 0 && (
                <div className="cards-area">
                  <h3 className="cards-title">Your First Quests</h3>
                  <div className="cards-grid">
                    {cards.map((card, idx) => (
                      <div key={idx} className={`card ${activatedCard === card ? 'activated' : ''}`}>
                        <div className="card-header">
                          <div className="card-icon" style={{ background: CardTypeColors[card.type] || '#6b7280' }}>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                              <polyline points="20 6 9 17 4 12" />
                            </svg>
                          </div>
                          <span className="card-type">{card.type}</span>
                          <span className="card-time">{card.time_estimate} min</span>
                        </div>
                        <h4 className="card-title">{card.title}</h4>
                        <p className="card-description">{card.description}</p>
                        <div className="card-criteria">
                          <p className="card-criteria-title">Done when:</p>
                          {card.done_criteria?.map((criterion, cIdx) => (
                            <div key={cIdx} className="criterion">
                              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                <polyline points="20 6 9 17 4 12" />
                              </svg>
                              <span>{criterion}</span>
                            </div>
                          ))}
                        </div>
                        <button
                          className={`card-button ${activatedCard === card ? 'active' : activatedCard !== null ? 'disabled' : 'inactive'}`}
                          onClick={() => setActivatedCard(card)}
                          disabled={activatedCard !== null && activatedCard !== card}
                        >
                          {activatedCard === card ? '✓ Activated' : 'Activate Quest'}
                        </button>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Input */}
              <div className="input-area">
                <div className="input-container">
                  <textarea
                    className="input-field"
                    value={input}
                    onChange={(e) => setInput(e.target.value)}
                    onKeyPress={handleKeyPress}
                    placeholder="Share what's on your mind..."
                    rows={1}
                    disabled={isLoading}
                  />
                  <button
                    className="send-button"
                    onClick={handleSend}
                    disabled={!input.trim() || isLoading}
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <line x1="22" y1="2" x2="11" y2="13" />
                      <polygon points="22 2 15 22 11 13 2 9 22 2" />
                    </svg>
                  </button>
                </div>
              </div>
            </div>

            {/* Insights Sidebar */}
            <div className="sidebar">
              <div className="sidebar-header">
                <h2 className="sidebar-title">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z" />
                    <path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z" />
                  </svg>
                  Extracted Insights
                </h2>
                <p className="sidebar-subtitle">Real-time profile building</p>
              </div>

              <div className="sidebar-content">
                {/* Wow Profile */}
                <div className="insight-section">
                  <h3 className="insight-title">Wow Profile</h3>
                  {insights.wow_profile ? (
                    <div className="insight-value">
                      <div className="insight-value-text">{insights.wow_profile.type}</div>
                      <div className="insight-confidence">
                        {Math.round(insights.wow_profile.confidence * 100)}% confidence
                      </div>
                    </div>
                  ) : (
                    <div className="insight-empty">Detecting...</div>
                  )}
                </div>

                {/* Crisis Score */}
                <div className="insight-section">
                  <h3 className="insight-title">Crisis Level</h3>
                  <div className="crisis-display">
                    <span className="crisis-score" style={{ color: getCrisisColor(insights.crisis_score) }}>
                      {insights.crisis_score}/10
                    </span>
                  </div>
                  <div className="crisis-bar">
                    <div
                      className="crisis-bar-fill"
                      style={{
                        width: `${insights.crisis_score * 10}%`,
                        background: getCrisisColor(insights.crisis_score)
                      }}
                    />
                  </div>
                </div>

                {/* Life Domains */}
                <div className="insight-section">
                  <h3 className="insight-title">Life Domains</h3>
                  {insights.life_domains.length > 0 ? (
                    <div className="domain-list">
                      {insights.life_domains
                        .sort((a, b) => b.confidence - a.confidence)
                        .map((domain, idx) => (
                          <div key={idx} className="domain-item">
                            <span className="domain-name">{domain.domain}</span>
                            <span className="domain-confidence">
                              {Math.round(domain.confidence * 100)}%
                            </span>
                          </div>
                        ))}
                    </div>
                  ) : (
                    <div className="insight-empty">Mapping...</div>
                  )}
                </div>

                {/* Emotional Baseline */}
                <div className="insight-section">
                  <h3 className="insight-title">Emotional Baseline</h3>
                  <div className="baseline-item">
                    <div className="baseline-label">
                      <span>Stress Level</span>
                      <span>{insights.emotional_baseline.stress || '—'}/10</span>
                    </div>
                    <div className="baseline-bar">
                      <div
                        className="baseline-bar-fill"
                        style={{
                          width: insights.emotional_baseline.stress ? `${insights.emotional_baseline.stress * 10}%` : '0%',
                          background: '#ef4444'
                        }}
                      />
                    </div>
                  </div>
                  <div className="baseline-item">
                    <div className="baseline-label">
                      <span>Energy Level</span>
                      <span>{insights.emotional_baseline.energy || '—'}/10</span>
                    </div>
                    <div className="baseline-bar">
                      <div
                        className="baseline-bar-fill"
                        style={{
                          width: insights.emotional_baseline.energy ? `${insights.emotional_baseline.energy * 10}%` : '0%',
                          background: '#10b981'
                        }}
                      />
                    </div>
                  </div>
                </div>

                {/* Director Attributes */}
                {Object.keys(insights.director_attributes).length > 0 && (
                  <div className="insight-section">
                    <h3 className="insight-title">Director Attributes</h3>
                    <div className="attributes-list">
                      {insights.director_attributes.energy_reserve && (
                        <div className="attribute-item">
                          <span className="attribute-label">Energy Reserve</span>
                          <span className="attribute-value">{insights.director_attributes.energy_reserve}</span>
                        </div>
                      )}
                      {insights.director_attributes.processing_power && (
                        <div className="attribute-item">
                          <span className="attribute-label">Processing Power</span>
                          <span className="attribute-value">{insights.director_attributes.processing_power}</span>
                        </div>
                      )}
                      {insights.director_attributes.agency && (
                        <div className="attribute-item">
                          <span className="attribute-label">Agency</span>
                          <span className="attribute-value">{insights.director_attributes.agency}</span>
                        </div>
                      )}
                      {insights.director_attributes.momentum && (
                        <div className="attribute-item">
                          <span className="attribute-label">Momentum</span>
                          <span className="attribute-value">{insights.director_attributes.momentum}</span>
                        </div>
                      )}
                      {insights.director_attributes.support_infrastructure && (
                        <div className="attribute-item">
                          <span className="attribute-label">Support</span>
                          <span className="attribute-value">{insights.director_attributes.support_infrastructure}</span>
                        </div>
                      )}
                    </div>
                  </div>
                )}

                {/* Communication Style */}
                {Object.keys(insights.communication_style).length > 0 && (
                  <div className="insight-section">
                    <h3 className="insight-title">Communication Style</h3>
                    <div className="style-list">
                      {insights.communication_style.formality && (
                        <div className="style-item">
                          <span className="style-label">Formality</span>
                          <span className="style-value">{insights.communication_style.formality}</span>
                        </div>
                      )}
                      {insights.communication_style.detail_level && (
                        <div className="style-item">
                          <span className="style-label">Detail Level</span>
                          <span className="style-value">{insights.communication_style.detail_level}</span>
                        </div>
                      )}
                      {insights.communication_style.focus && (
                        <div className="style-item">
                          <span className="style-label">Focus</span>
                          <span className="style-value">{insights.communication_style.focus}</span>
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </div>

              {/* Success Metrics */}
              <div className="metrics-footer">
                <h3 className="metrics-title">Success Metrics</h3>
                <div className="metrics-list">
                  <div className="metric-item">
                    {timeToFirstCard && timeToFirstCard <= 300 ? (
                      <svg className="metric-icon complete" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                        <polyline points="22 4 12 14.01 9 11.01" />
                      </svg>
                    ) : (
                      <div className="metric-icon incomplete" />
                    )}
                    <span>First cards ≤ 5 min</span>
                  </div>
                  <div className="metric-item">
                    {insights.wow_profile?.confidence >= 0.7 ? (
                      <svg className="metric-icon complete" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                        <polyline points="22 4 12 14.01 9 11.01" />
                      </svg>
                    ) : (
                      <div className="metric-icon incomplete" />
                    )}
                    <span>Profile detected (70%+)</span>
                  </div>
                  <div className="metric-item">
                    {insights.life_domains.some(d => d.confidence >= 0.8) ? (
                      <svg className="metric-icon complete" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                        <polyline points="22 4 12 14.01 9 11.01" />
                      </svg>
                    ) : (
                      <div className="metric-icon incomplete" />
                    )}
                    <span>Domain mapped (80%+)</span>
                  </div>
                  <div className="metric-item">
                    {activatedCard ? (
                      <svg className="metric-icon complete" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                        <polyline points="22 4 12 14.01 9 11.01" />
                      </svg>
                    ) : (
                      <div className="metric-icon incomplete" />
                    )}
                    <span>Card activated</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
